From 24ac7a943f1c77db26fe9aca96285ca2fb97b637 Mon Sep 17 00:00:00 2001
From: Sam Liddicott <sam@liddicott.com>
Date: Tue, 7 Jan 2014 09:21:53 -0800
Subject: [PATCH] ANDROID: xt_quota2: remove trailing junk which might have a
 digit in it

Make sure string only contains the characters specified by userspace.

Fix cherry-picked from xtables-extensions project

Signed-off-by: Sam Liddicott <sam@liddicott.com>
Bug: 196046570
Test: passed netd test suites
Fixes: 10cda83af99d ("ANDROID: netfilter: xt_quota2: adding the
original quota2 from xtables-addons")
Signed-off-by: Todd Kjos <tkjos@google.com>
(cherry picked from https://git.code.sf.net/p/xtables-addons/xtables-addons
bc2bcc383c70b293bd816c29523a952ca8736fb5)
Change-Id: I965448564906e5fbf0fe6d6414f44d9e257ea195
CVE-2021-0961
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
---
 net/netfilter/xt_quota2.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/net/netfilter/xt_quota2.c b/net/netfilter/xt_quota2.c
index f19b0c1bdd7..45672f54a00 100644
--- a/net/netfilter/xt_quota2.c
+++ b/net/netfilter/xt_quota2.c
@@ -136,6 +136,8 @@ static int quota_proc_write(struct file *file, const char __user *input,
 	if (copy_from_user(buf, input, size) != 0)
 		return -EFAULT;
 	buf[sizeof(buf)-1] = '\0';
+	if (size < sizeof(buf))
+		buf[size] = '\0';
 
 	spin_lock_bh(&e->lock);
 	e->quota = simple_strtoull(buf, NULL, 0);
